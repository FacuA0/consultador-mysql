<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="principal.css">

        <title>Consultas SQL</title>
    </head>
    <body>
        <main>
            <h1>Consultas SQL</h1>
            <p>Usa el campo inferior para escribir consultas a un servidor MySQL. Escribe <code>USE &lt;base de datos&gt;;</code> para cambiar de base de datos.</p>
            <p id="info-database">Base de datos: &lt;ninguna&gt;</p>

            <div id="entrada">
                <input type="text" id="campo">
                <button onclick="consultar()" id="boton-consultar">Consultar</button>
            </div>
    
            <p>Resultado: </p>
            <div id="resultado">
                <p id="error"></p>
                <table id="tabla"></table>
            </div>

            <div id="pagina-vieja">
                <a href="/databases">Ver bases de datos y tablas</a> (antiguo).
            </div>
        </main>

        <script>
            let database = "";

            let inputCampo = document.getElementById("campo");
            let infoDatabase = document.getElementById("info-database");
            let divResultado = document.getElementById("resultado");
            let resError = document.getElementById("error");
            let resTabla = document.getElementById("tabla");

            function consultar() {  
                let consulta = inputCampo.value;

                // Establecer base de datos operativa.
                if (consulta.toUpperCase().startsWith("USE ") && consulta.endsWith(";")) {
                    database = consulta.toLowerCase().slice(4, -1);
                    let htmlDatabase;

                    if (database != "") htmlDatabase = "<b>" + database + "</b>";
                    else htmlDatabase = "&gt;ninguna&lt;";

                    infoDatabase.innerHTML = "Base de datos: " + htmlDatabase;
                    return;
                }

                // Dirección de consulta. Si hay base de datos seleccionada, incluirla aparte.
                let direccion = "/query?sql=" + consulta + (database != "" ? "&database=" + database : "");

                fetch(direccion)
                .then(res => res.json())
                .then(json => {
                    if (!json.ok) {
                        resError.textContent = "Error de consulta: " + json.error;
                        resError.style.display = "block";
                        resTabla.style.display = "none";
                        return;
                    }

                    resTabla.innerHTML = "";

                    let tr1 = document.createElement("tr");
                    for (campo of json.campos) {
                        let th = document.createElement("th");
                        th.textContent = campo;
                        tr1.appendChild(th);
                    }
                    resTabla.appendChild(tr1);
                    
                    for (fila of json.registros) {
                        let tr = document.createElement("tr");
                        for (valor of fila) {
                            let td = document.createElement("td");
                            td.textContent = valor;
                            tr.appendChild(td);
                        }
                        resTabla.appendChild(tr);
                    }
                    resTabla.style.display = "table";
                    resError.style.display = "none";
                })
                .catch(err => {
                    resError.textContent = "Error de conexión: " + err.toString();
                    resError.style.display = "block";
                    resTabla.style.display = "none";
                });
            }
        </script>
    </body>
</html>