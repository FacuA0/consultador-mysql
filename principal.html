<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="principal.css">

        <title>Consultas SQL</title>
    </head>
    <body>
        <main>
            <h1>Consultas SQL</h1>
            <p>Usa el campo inferior para escribir consultas a un servidor MySQL. Escribe <code>USE &lt;base de datos&gt;;</code> para cambiar de base de datos.</p>
            <p id="info-database">Base de datos: &lt;ninguna&gt;</p>

            <div id="entrada">
                <input type="text" id="campo">
                <button onclick="consultar()" id="boton-consultar">Consultar</button>
            </div>
    
            <p>Resultado: </p>
            <div id="resultado">
                <p id="mensaje"></p>
                <table id="tabla"></table>
            </div>

            <div id="pagina-vieja">
                <a href="/databases">Ver bases de datos y tablas</a> (antiguo).
            </div>
        </main>

        <script>
            let database = "";

            let inputCampo = document.getElementById("campo");
            let infoDatabase = document.getElementById("info-database");
            let divResultado = document.getElementById("resultado");
            let resMensaje = document.getElementById("mensaje");
            let resTabla = document.getElementById("tabla");

            function consultar() {  
                let consulta = inputCampo.value;

                // Establecer base de datos operativa.
                if (consulta.toUpperCase().startsWith("USE ") && consulta.endsWith(";")) {
                    database = consulta.toLowerCase().slice(4, -1);
                    let htmlDatabase;

                    if (database != "") htmlDatabase = "<b>" + database + "</b>";
                    else htmlDatabase = "&lt;ninguna&gt;";

                    infoDatabase.innerHTML = "Base de datos: " + htmlDatabase;
                    return;
                }

                resTabla.innerHTML = "";
                resMensaje.style.display = "none";

                // Dirección de consulta. Si hay base de datos seleccionada, incluirla aparte.
                let direccion = "/query?sql=" + consulta + (database != "" ? "&database=" + database : "");

                fetch(direccion)
                .then(res => res.json())
                .then(json => {
                    if (!json.ok) {
                        mostrarMensaje("Error de consulta: " + json.error, true);
                        return;
                    }

                    if (json.resultado) {
                        let res = json.resultado;
                        mostrarMensaje(`¡Operación exitosa! ${res.message}<br><br>Filas afectadas: ${res.affectedRows}<br>Estado del servidor DB: ${res.serverStatus}<br>Advertencias: ${res.warningCount}`);
                    }
                    else {
                        rellenarTabla(json.campos, json.registros);
                    }
                })
                .catch(err => {
                    mostrarMensaje("Error de conexión: " + err.toString(), true);
                });
            }

            function rellenarTabla(campos, registros) {
                let cabecera = document.createElement("tr");
                for (campo of campos) {
                    let th = document.createElement("th");
                    th.textContent = campo;
                    cabecera.appendChild(th);
                }
                resTabla.appendChild(cabecera);
                
                for (fila of registros) {
                    let tr = document.createElement("tr");
                    for (valor of fila) {
                        let td = document.createElement("td");
                        td.textContent = valor;
                        tr.appendChild(td);
                    }
                    resTabla.appendChild(tr);
                }
            }

            function mostrarMensaje(mensaje, error) {
                resMensaje.innerHTML = mensaje;
                resMensaje.className = error ? "error" : "";
                resMensaje.style.display = "block";
            }
        </script>
    </body>
</html>